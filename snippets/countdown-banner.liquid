{% if section.settings.countdown_enabled %}
  <div x-data='countdownBanner()' x-init='init()'>
    <div
      id='countdownBanner'
      class='fixed top-0 left-0 right-0 z-30 transition-transform duration-300'
      style='background-color: {{ section.settings.countdown_bg_color | default: "#000000" }};'
    >
      <div class='mx-auto px-4 sm:px-6 max-w-8xl'>
        <div class='flex flex-row items-center justify-center py-2 gap-2 sm:gap-4 text-center'>
          <div
            class='text-white flex-1 md:flex-none text-xs sm:text-sm font-medium whitespace-nowrap flex items-center space-x-2'
            style='color: {{ section.settings.countdown_text_color | default: "#ffffff" }};'
          >
            {% if section.settings.countdown_show_timer != false %}
              <span x-text='formattedTime'></span>
            {% endif %}
            {% if section.settings.countdown_title != blank %}
              <span
                class='text-white text-xs sm:text-sm font-bold whitespace-nowrap'
                style='color: {{ section.settings.countdown_text_color | default: "#ffffff" }};'
              >
                {{ section.settings.countdown_title }}
              </span>
            {% endif %}
          </div>
          {% if section.settings.notify_button_action == "link"
            and section.settings.notify_button_link != blank
          %}
            <div class=''>
              <a
                href='{{ section.settings.notify_button_link }}'
                class='px-4 py-1.5 text-sm font-medium whitespace-nowrap transition-colors hover:opacity-90 inline-block text-center no-underline'
                style='background-color: {{ section.settings.notify_button_bg_color | default: "#ea580c" }}; color: {{ section.settings.notify_button_text_color | default: "#ffffff" }};'
              >
                {{ section.settings.notify_button_text | default: "NOTIFY ME" }}
              </a>
            </div>
          {% else %}
            <button
              @click='openDrawer()'
              class='px-4 py-1.5 text-sm font-medium whitespace-nowrap transition-colors hover:opacity-90'
              style='background-color: {{ section.settings.notify_button_bg_color | default: "#ea580c" }}; color: {{ section.settings.notify_button_text_color | default: "#ffffff" }};'
            >
              {{ section.settings.notify_button_text | default: "NOTIFY ME" }}
            </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Notification Drawer -->
    <div
      x-show='drawerOpen'
      x-transition:enter='transition ease-out duration-300'
      x-transition:enter-start='opacity-0 translate-y-[-100%]'
      x-transition:enter-end='opacity-100 translate-y-0'
      x-transition:leave='transition ease-in duration-200'
      x-transition:leave-start='opacity-100 translate-y-0'
      x-transition:leave-end='opacity-0 translate-y-[-100%]'
      @click.away='closeDrawer()'
      class='fixed top-0 left-0 right-0 z-50 bg-black text-white'
      style='display: none;'
    >
      <div class='relative w-full'>
        <button
          @click='closeDrawer()'
          class='absolute right-4 top-4 text-white hover:text-gray-300 transition-colors'
          aria-label='Close'
        >
          <svg
            class='w-6 h-6'
            fill='none'
            stroke='currentColor'
            viewBox='0 0 24 24'
          >
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'/>
          </svg>
        </button>
        <div class='max-w-2xl mx-auto px-4 sm:px-6 py-8'>
          <div class='klaviyo-form-QReqgv hidden lg:block'></div>
          <div class='klaviyo-form-XV8rPN lg:hidden'></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function countdownBanner() {
      return {
        days: 0,
        hours: 0,
        minutes: 0,
        seconds: 0,
        drawerOpen: false,

        init() {
          this.startCountdown()
          this.setupScrollBehavior()
          this.updateBannerHeight()
          window.addEventListener('resize', () => this.updateBannerHeight())
        },

        updateBannerHeight() {
          const banner = document.getElementById('countdownBanner')
          if (banner) {
            const height = banner.offsetHeight
            document.documentElement.style.setProperty(
              '--countdown-banner-height',
              height + 'px'
            )
          }
        },

        setupScrollBehavior() {
          const banner = document.getElementById('countdownBanner')
          const header = document.getElementById('siteHeader')
          if (!banner || !header) return

          let ticking = false
          const handleScroll = () => {
            if (!ticking) {
              window.requestAnimationFrame(() => {
                const scrollTop =
                  window.pageYOffset || document.documentElement.scrollTop
                const bannerHeight = banner.offsetHeight

                if (scrollTop > bannerHeight) {
                  banner.style.transform = 'translateY(-100%)'
                  header.style.top = '0'
                } else {
                  banner.style.transform = 'translateY(0)'
                  header.style.top = bannerHeight + 'px'
                }
                ticking = false
              })
              ticking = true
            }
          }
          window.addEventListener('scroll', handleScroll, { passive: true })
        },

        normalizeTargetDate() {
          let targetDateString =
            '{{ section.settings.countdown_target_date | default: "2025-12-31T23:59:59" }}'
          let cleanDateString = targetDateString.trim()

          if (!cleanDateString.includes('T')) {
            cleanDateString += 'T23:59:59'
          }

          if (
            !cleanDateString.includes('Z') &&
            !cleanDateString.includes('+') &&
            !cleanDateString.includes('-', 10)
          ) {
            cleanDateString += 'Z'
          }

          return new Date(cleanDateString).getTime()
        },

        startCountdown() {
          const updateCountdown = () => {
            const targetDate = this.normalizeTargetDate()
            const now = new Date().getTime()
            const distance = targetDate - now

            if (distance < 0) {
              this.days = this.hours = this.minutes = this.seconds = 0
              return
            }

            this.days = Math.floor(distance / (1000 * 60 * 60 * 24))
            this.hours = Math.floor(
              (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            )
            this.minutes = Math.floor(
              (distance % (1000 * 60 * 60)) / (1000 * 60)
            )
            this.seconds = Math.floor((distance % (1000 * 60)) / 1000)
          }
          updateCountdown()
          setInterval(updateCountdown, 1000)
        },

        get formattedTime() {
          const pad = n => String(n).padStart(2, '0')
          return `${pad(this.days)}:${pad(this.hours)}:${pad(this.minutes)}:${pad(this.seconds)}`
        },

        openDrawer() {
          this.drawerOpen = true
          document.body.style.overflow = 'hidden'
        },

        closeDrawer() {
          this.drawerOpen = false
          document.body.style.overflow = ''
        },
      }
    }
  </script>
{% endif %}
