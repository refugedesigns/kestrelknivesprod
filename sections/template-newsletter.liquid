{% schema %}
{
  "name": "Newsletter Page",
  "settings": [
    {
      "type": "text",
      "id": "page_title",
      "label": "Page Title",
      "default": "SUBSCRIBE TO OUR NEWSLETTER"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Stay sharp - Join the Kestrel List. Be first for drops, gear launches and giveaways."
    },
    {
      "type": "color",
      "id": "form_bg_color",
      "label": "Form Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "input_bg_color",
      "label": "Input Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Input Border Color",
      "default": "#d1d5db"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Button Background Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "JOIN THE HUNT"
    },
    {
      "type": "text",
      "id": "success_title",
      "label": "Success Notification Title",
      "default": "Successfully signed up!"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Thanks for signing up! Check your email for updates."
    },
    {
      "type": "select",
      "id": "success_button_color",
      "label": "Success Notification Color",
      "options": [
        {
          "value": "bg-orange-500",
          "label": "Orange"
        },
        {
          "value": "bg-blue-500",
          "label": "Blue"
        },
        {
          "value": "bg-green-500",
          "label": "Green"
        },
        {
          "value": "bg-red-500",
          "label": "Red"
        },
        {
          "value": "bg-purple-500",
          "label": "Purple"
        },
        {
          "value": "bg-gray-800",
          "label": "Dark Gray"
        },
        {
          "value": "bg-black",
          "label": "Black"
        }
      ],
      "default": "bg-orange-500"
    }
  ],
  "presets": [
    {
      "name": "Newsletter Page"
    }
  ]
}
{% endschema %}

<div class='max-w-4xl mx-auto py-12 px-4 md:px-0 md:pt-16'>
  <!-- Page Header -->
  <div class='text-center mb-12 border-b border-gray-200 pb-12'>
    <h1
      id='newsletter-scroll-target'
      class='text-3xl md:text-4xl font-bold text-gray-900 mb-4'
    >
      {{ section.settings.page_title }}
    </h1>
    {% if section.settings.subtitle != blank %}
      <p class='text-lg text-gray-600'>
        {{ section.settings.subtitle }}
      </p>
    {% endif %}
  </div>

  <!-- Newsletter Form -->
  <div class='max-w-2xl mx-auto'>
    <div
      class='rounded-lg shadow-lg p-8 md:p-12'
      style='background-color: {{ section.settings.form_bg_color | default: "#ffffff" }};'
      x-data='newsletterForm()'
    >
      <form @submit.prevent='submit' class='w-full' novalidate>
        <div class='space-y-6'>
          <!-- Name Field -->
          <div>
            <label class='block text-sm font-medium text-gray-700 mb-2'>
              Full Name
            </label>
            <input
              type='text'
              x-model='name'
              name='contact[name]'
              placeholder='Enter your full name'
              class='w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500'
              style='background-color: {{ section.settings.input_bg_color | default: "#ffffff" }}; border-color: {{ section.settings.input_border_color | default: "#d1d5db" }};'
              required
            >
          </div>

          <!-- Email Field -->
          <div>
            <label class='block text-sm font-medium text-gray-700 mb-2'>
              Email Address
            </label>
            <input
              type='email'
              x-model='email'
              name='contact[email]'
              placeholder='Enter your email address'
              class='w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500'
              style='background-color: {{ section.settings.input_bg_color | default: "#ffffff" }}; border-color: {{ section.settings.input_border_color | default: "#d1d5db" }};'
              required
            >
          </div>

          <input type='hidden' name='contact[tags]' value='newsletter'>

          <!-- Submit Button -->
          <button
            type='submit'
            :disabled='submitting'
            class='w-full rounded-md cursor-pointer py-3 px-6 border-2 font-semibold uppercase tracking-wide transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed'
            style='background-color: {{ section.settings.button_bg_color | default: "#000000" }}; color: {{ section.settings.button_text_color | default: "#ffffff" }}; border-color: {{ section.settings.button_bg_color | default: "#000000" }};'
          >
            <span
              x-text="submitting ? 'Signing Up...' : '{{ section.settings.button_text | default: 'JOIN THE HUNT' }}'"
            ></span>
          </button>
        </div>

        <!-- Error Message -->
        <div
          x-show='errorMessage'
          class='mt-6 text-sm text-red-600 text-center'
          x-text='errorMessage'
        ></div>
      </form>

      <!-- Success Notification -->
      <div
        x-show='showSuccess'
        x-transition:enter='transition ease-out duration-300'
        x-transition:enter-start='opacity-0 scale-95'
        x-transition:enter-end='opacity-100 scale-100'
        x-transition:leave='transition ease-in duration-200'
        x-transition:leave-start='opacity-100 scale-100'
        x-transition:leave-end='opacity-0 scale-95'
        class='absolute inset-0 flex items-center justify-center z-10 bg-white bg-opacity-95 rounded-lg'
        style='display: none;'
      >
        <div class='text-center p-8'>
          <div class='inline-block mb-4'>
            <svg
              class='w-16 h-16 text-green-500'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/>
            </svg>
          </div>
          <h3 class='text-lg font-semibold text-gray-900 mb-2'>
            {{
              section.settings.success_title
              | default: "Successfully signed up!"
            }}
          </h3>
          <div class='{{ section.settings.success_button_color | default: "bg-orange-500" }} text-white py-3 px-6 rounded-lg inline-block'>
            <p class='font-semibold'>
              {{
                section.settings.success_message
                | default: "Thanks for signing up! Check your email for updates."
              }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Newsletter Form Script -->
<script>
  function newsletterForm() {
    return {
      showSuccess: false,
      name: '',
      email: '',
      submitting: false,
      errorMessage: '',

      async submit(event) {
        this.errorMessage = ''

        // Validate name field
        if (!this.name || !this.name.trim()) {
          this.errorMessage = 'Please enter your full name.'
          return
        }

        // Validate email field
        if (!this.email || !this.email.trim()) {
          this.errorMessage = 'Please enter your email address.'
          return
        }

        // Extra safety regex for email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/
        if (!emailRegex.test(this.email)) {
          this.errorMessage = 'Please enter a valid email address.'
          return
        }

        // Passed validation â†’ submit
        this.submitting = true

        const form = event.target
        const formData = new FormData(form)

        try {
          const response = await fetch('/contact', {
            method: 'POST',
            body: formData,
            headers: { Accept: 'text/html,application/xhtml+xml' },
            credentials: 'same-origin',
          })

          if (response.ok) {
            this.showSuccess = true
            this.name = ''
            this.email = ''
            setTimeout(() => {
              this.showSuccess = false
            }, 5000)
          } else {
            const text = await response.text()
            this.errorMessage = 'Submission failed. Please try again.'
            console.warn('Form submission response text:', text)
          }
        } catch (err) {
          console.error('Error submitting form:', err)
          this.errorMessage = 'An error occurred. Please try again later.'
        } finally {
          this.submitting = false
        }
      },
    }
  }
</script>
