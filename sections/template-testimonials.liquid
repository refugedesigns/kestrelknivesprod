{% schema %}
{
  "name": "Testimonials Section",
  "settings": [
    {
      "type": "text",
      "id": "headline",
      "label": "Section Headline",
      "default": "What our customers say"
    },
    {
      "type": "checkbox",
      "id": "enable_carousel",
      "label": "Enable Product Reviews Carousel",
      "default": true,
      "info": "Show product reviews carousel when there are more than 6 testimonials"
    },
    {
      "type": "text",
      "id": "carousel_title",
      "label": "Carousel Title",
      "default": "Product Reviews"
    },
    {
      "type": "checkbox",
      "id": "show_carousel_title",
      "label": "Show carousel title",
      "default": true
    },
    {
      "type": "range",
      "id": "carousel_max_width",
      "label": "Carousel max width (px)",
      "min": 900,
      "max": 1600,
      "step": 50,
      "default": 1200
    },
    {
      "type": "range",
      "id": "mobile_columns",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Mobile columns",
      "default": 1,
      "info": "Number of testimonials per row on mobile"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Desktop columns",
      "default": 3,
      "info": "Number of testimonials per row on desktop"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "text",
          "id": "quote",
          "label": "Quote"
        },
        {
          "type": "text",
          "id": "author",
          "label": "Author name"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author photo"
        },
        {
          "type": "select",
          "id": "object_fit",
          "label": "Image object-fit",
          "default": "cover",
          "options": [
            { "value": "cover", "label": "Cover" },
            { "value": "contain", "label": "Contain" },
            { "value": "fill", "label": "Fill (stretch)" },
            { "value": "none", "label": "None" },
            { "value": "scale-down", "label": "Scale down" }
          ]
        },
        {
          "type": "select",
          "id": "object_position",
          "label": "Image position",
          "default": "center",
          "options": [
            { "value": "top", "label": "Top" },
            { "value": "center", "label": "Center" },
            { "value": "bottom", "label": "Bottom" }
          ]
        }
      ]
    },
    {
      "type": "carousel_review",
      "name": "Carousel Review Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Product/Image" },
        {
          "type": "range",
          "id": "rating",
          "label": "Rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        { "type": "textarea", "id": "review_text", "label": "Review Text" },
        { "type": "text", "id": "author", "label": "Author" },
        { "type": "text", "id": "product_title", "label": "Product Title" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Default testimonials"
    }
  ]
}
{% endschema %}

<div class='py-4 px-4 bg-gray-50 min-h-screen'>
  <div class='mx-auto'>
    <!-- Section Header -->
    <div class='text-center mb-12'>
      <h2 class='text-3xl md:text-4xl font-bold text-gray-900 mb-4'>
        {{ section.settings.headline }}
      </h2>
    </div>

    <!-- First 6 Testimonials (only testimonial blocks) -->
    {% assign mobile_cols = section.settings.mobile_columns | default: 1 %}
    {% assign desktop_cols = section.settings.desktop_columns | default: 3 %}
    {% assign break_count = desktop_cols | times: 2 %}
    <style>
      .testimonials-grid-first {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat({{mobile_cols}}, minmax(0, 1fr));
      }
      @media (min-width: 768px) {
        .testimonials-grid-first {
          grid-template-columns: repeat({{desktop_cols}}, minmax(0, 1fr));
        }
      }
    </style>
    <style>
      .testimonial-card__overlay {
        padding: 0.9rem 1.25rem;
      }
      @media (min-width: 768px) {
        .testimonial-card__overlay {
          padding: 1.1rem 1.5rem;
        }
      }
      .testimonial-card__quote {
        font-size: 0.85rem !important;
        line-height: 1.35 !important;
        margin: 0 0 0.15rem !important;
        padding: 0 !important;
        border: none !important;
        margin-left: 0 !important;
      }
      .testimonial-card__quote::before,
      .testimonial-card__quote::after {
        content: none !important;
      }
      .testimonial-card__author {
        font-size: 0.75rem !important;
        line-height: 1.2 !important;
        margin: 0;
      }
    </style>
    <div class='testimonials-grid-first'>
      {% assign rendered = 0 %}
      {% for block in section.blocks %}
        {% if block.type == "testimonial" and rendered < break_count %}
          {% assign has_image = block.settings.author_image %}
          {% if has_image %}
            {% assign img_ratio = has_image.aspect_ratio | default: 1 %}
          {% endif %}
          <div
            class='relative w-full rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer testimonial-card'
            {% if has_image %}
              style='aspect-ratio: {{ img_ratio }};'
            {% else %}
              style='min-height: 25rem;'
            {% endif %}
            data-quote='{{ block.settings.quote | strip_newlines | escape }}'
            data-author='{{ block.settings.author | escape }}'
            data-image='{% if block.settings.author_image %}{{ block.settings.author_image | image_url: width: 2000 | escape }}{% endif %}'
            data-fit='{{ block.settings.object_fit | default: "cover" }}'
            data-pos='{{ block.settings.object_position | default: "center" }}'
            onclick='(function(el){window.dispatchEvent(new CustomEvent("open-testimonial",{detail:{quote:el.getAttribute("data-quote"),author:el.getAttribute("data-author"),author_image:el.getAttribute("data-image")||null,object_fit:el.getAttribute("data-fit")||"cover",object_position:el.getAttribute("data-pos")||"center"}}))})(this)'
          >
            <!-- Background Image -->
            {% if has_image %}
              {% assign fit = block.settings.object_fit | default: "cover" %}
              {% assign pos = block.settings.object_position
                | default: "center"
              %}
              {% assign pos_map = "top:50%_0%,center:50%_50%,bottom:50%_100%"
                | split: ","
              %}
              {% assign pos_css = "50%_50%" %}
              {% for pair in pos_map %}
                {% assign kv = pair | split: ":" %}
                {% if kv[0] == pos %}{% assign pos_css = kv[1] %}{% endif %}
              {% endfor %}
              {% assign img_width = has_image.width | default: 400 %}
              {% assign img_height = has_image.height | default: 400 %}
              <img
                src='{{ has_image | image_url: width: 800 }}'
                alt='Photo of {{ block.settings.author }}'
                width='{{ img_width }}'
                height='{{ img_height }}'
                loading='lazy'
                style='width:100%;height:100%;object-fit:{{ fit }};object-position:{{ pos_css | replace: "_", " " }};'
              >
            {% else %}
              <div class='w-full h-full bg-gray-300 flex items-center justify-center'>
                <span class='text-gray-500 text-sm'>No image</span>
              </div>
            {% endif %}

            <!-- Content Overlay with Background -->
            <div class='absolute bottom-0 left-0 right-0 text-white bg-black/60 flex flex-col gap-0 testimonial-card__overlay'>
              <!-- Quote -->
              <blockquote
                class='testimonial-card__quote text-white italic'
                data-truncate='quote'
              >
                "{{ block.settings.quote }}"
              </blockquote>

              <!-- Author Name -->
              <cite class='testimonial-card__author text-white font-semibold not-italic'>
                {{ block.settings.author }}
              </cite>
            </div>
          </div>
          {% assign rendered = rendered | plus: 1 %}
        {% endif %}
      {% endfor %}
    </div>

    {% if section.settings.enable_carousel %}
      <div
        class='my-8'
        style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
      >
        {% if section.settings.show_carousel_title %}
          <h3 class='text-2xl font-bold text-gray-900 text-center mb-4'>
            {{ section.settings.carousel_title }}
          </h3>
        {% endif %}

        <swiper-container
          class='testimonials-carousel'
          pagination='true'
          pagination-clickable='true'
          navigation='false'
          space-between='20'
          slides-per-view='1'
          centered-slides='true'
          autoplay='true'
          autoplay-delay='5000'
          autoplay-disable-on-interaction='false'
          loop='false'
        >
          {% assign has_reviews = false %}
          {% for product in collections.all.products %}
            {% if product.reviews.size > 0 %}
              {% assign has_reviews = true %}
              {% for review in product.reviews %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if product.featured_image %}
                          <img
                            src='{{ product.featured_image | image_url: width: 400 }}'
                            alt='{{ product.title }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 px-4 pb-4 pt-3 md:px-8 md:pb-8 md:pt-6 flex flex-col carousel-review-content'>
                        <div class='flex items-center mb-2 md:mb-3 carousel-review-stars'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= review.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- review.rating }}/5</span
                          >
                        </div>
                        <div class='carousel-review-text'>
                          <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed italic carousel-review-quote'>
                            "{{ review.content }}"
                          </blockquote>
                          <div class='flex items-center carousel-review-author'>
                            <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                              <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                                {{- review.author | slice: 0, 1 | upcase -}}
                              </span>
                            </div>
                            <div>
                              <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                                {{- review.author -}}
                              </cite>
                              <p class='text-xs md:text-sm text-gray-500'>
                                {{ product.title }}
                              </p>
                            </div>
                            <div class='flex text-yellow-400 ml-3 carousel-review-stars-inline'>
                              {% for i in (1..5) %}
                                {% if i <= review.rating %}
                                  <svg
                                    class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                    viewBox='0 0 20 20'
                                  >
                                    <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                  </svg>
                                {% else %}
                                  <svg
                                    class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                    viewBox='0 0 20 20'
                                  >
                                    <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                  </svg>
                                {% endif %}
                              {% endfor %}
                            </div>
                            <button
                              type='button'
                              class='carousel-review-close'
                            >
                              Show less
                            </button>
                          </div>
                        </div>
                        <div class='carousel-review-footer'>
                          <button
                            type='button'
                            class='carousel-review-toggle'
                          >
                            Read more
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endfor %}
            {% endif %}
          {% endfor %}

          {% unless has_reviews %}
            {% assign manual_count = 0 %}
            {% for block in section.blocks %}
              {% if block.type == "carousel_review" %}
                {% assign manual_count = manual_count | plus: 1 %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if block.settings.image %}
                          <img
                            src='{{ block.settings.image | image_url: width: 400 }}'
                            alt='{{ block.settings.product_title | default: block.settings.author }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 px-4 pb-4 pt-3 md:px-8 md:pb-8 md:pt-6 flex flex-col carousel-review-content'>
                        <div class='flex items-center mb-2 md:mb-3 carousel-review-stars'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= block.settings.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- block.settings.rating }}/5</span
                          >
                        </div>
                        <div class='carousel-review-text'>
                          <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed italic carousel-review-quote'>
                            "{{ block.settings.review_text }}"
                          </blockquote>
                          <div class='flex items-center carousel-review-author'>
                            <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                              <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                                {{-
                                  block.settings.author
                                  | slice: 0, 1
                                  | upcase
                                -}}
                              </span>
                            </div>
                            <div>
                              <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                                {{- block.settings.author -}}
                              </cite>
                              <p class='text-xs md:text-sm text-gray-500'>
                                {{ block.settings.product_title }}
                              </p>
                            </div>
                            <div class='flex text-yellow-400 ml-3 carousel-review-stars-inline'>
                              {% for i in (1..5) %}
                                {% if i <= block.settings.rating %}
                                  <svg
                                    class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                    viewBox='0 0 20 20'
                                  >
                                    <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                  </svg>
                                {% else %}
                                  <svg
                                    class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                    viewBox='0 0 20 20'
                                  >
                                    <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                  </svg>
                                {% endif %}
                              {% endfor %}
                            </div>
                            <button
                              type='button'
                              class='carousel-review-close'
                            >
                              Show less
                            </button>
                          </div>
                        </div>
                        <div class='carousel-review-footer'>
                          <button
                            type='button'
                            class='carousel-review-toggle'
                          >
                            Read more
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endif %}
            {% endfor %}
            {% if manual_count == 0 %}
              <!-- Placeholder Review (no product reviews, no manual slides) -->
              <swiper-slide>
                <div class='bg-white rounded-lg shadow-lg overflow-hidden mx-auto max-w-5xl'>
                  <div class='flex flex-col md:flex-row h-auto md:h-80'>
                    <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                      {{
                        "product-1"
                        | placeholder_svg_tag: "w-full h-full bg-gray-200 object-cover"
                      }}
                    </div>
                    <div class='w-full md:w-1/2 px-4 pb-4 pt-3 md:px-8 md:pb-8 md:pt-6 flex flex-col carousel-review-content'>
                      <div class='flex items-center mb-2 md:mb-3 carousel-review-stars'>
                        <div class='flex text-yellow-400 mr-3'>
                          {% for i in (1..5) %}
                            <svg
                              class='w-4 h-4 md:w-5 md:h-5 fill-current'
                              viewBox='0 0 20 20'
                            >
                              <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                            </svg>
                          {% endfor %}
                        </div>
                        <span class='text-xs md:text-sm text-gray-600 font-medium'
                          >5/5</span
                        >
                      </div>
                      <div class='carousel-review-text'>
                        <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed italic carousel-review-quote'>
                          "Add your first review in the theme editor."
                        </blockquote>
                        <div class='flex items-center carousel-review-author'>
                          <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                            <span class='text-gray-600 font-semibold text-xs md:text-sm'
                              >A</span
                            >
                          </div>
                          <div>
                            <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'
                              >Anonymous</cite
                            >
                            <p class='text-xs md:text-sm text-gray-500'>
                              Product Name
                            </p>
                          </div>
                          <div class='flex text-yellow-400 ml-3 carousel-review-stars-inline'>
                            {% for i in (1..5) %}
                              <svg
                                class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                viewBox='0 0 20 20'
                              >
                                <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                              </svg>
                            {% endfor %}
                          </div>
                          <button
                            type='button'
                            class='carousel-review-close'
                          >
                            Show less
                          </button>
                        </div>
                      </div>
                      <div class='carousel-review-footer'>
                        <button
                          type='button'
                          class='carousel-review-toggle'
                        >
                          Read more
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </swiper-slide>
            {% endif %}
          {% endunless %}
        </swiper-container>
      </div>
    {% endif %}

    <!--
      Product Reviews Carousel (disabled here; moved below grid to avoid gaps)
    -->
    {% if false
      and section.settings.enable_carousel
      and section.blocks.size > 8
    %}
      <div
        class='mt-16'
        style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
      >
        {% if section.settings.show_carousel_title %}
          <h3 class='text-2xl font-bold text-gray-900 text-center mb-8'>
            {{ section.settings.carousel_title }}
          </h3>
        {% endif %}

        <!-- Swiper Carousel -->
        <swiper-container
          class='testimonials-carousel'
          pagination='true'
          pagination-clickable='true'
          navigation='false'
          space-between='20'
          slides-per-view='1'
          centered-slides='true'
          autoplay='true'
          autoplay-delay='5000'
          autoplay-disable-on-interaction='false'
          loop='false'
        >
          {% assign has_reviews = false %}
          {% for product in collections.all.products %}
            {% if product.reviews.size > 0 %}
              {% assign has_reviews = true %}
              {% for review in product.reviews %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if product.featured_image %}
                          <img
                            src='{{ product.featured_image | image_url: width: 400 }}'
                            alt='{{ product.title }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                        <div class='flex items-center mb-3 md:mb-4'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= review.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- review.rating }}/5</span
                          >
                        </div>
                        <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                          "{{ review.content }}"
                        </blockquote>
                        <div class='flex items-center'>
                          <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                            <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                              {{- review.author | slice: 0, 1 | upcase -}}
                            </span>
                          </div>
                          <div>
                            <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                              {{- review.author -}}
                            </cite>
                            <p class='text-xs md:text-sm text-gray-500'>
                              {{ product.title }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endfor %}
            {% endif %}
          {% endfor %}

          {% unless has_reviews %}
            {% assign manual_count = 0 %}
            {% for block in section.blocks %}
              {% if block.type == "carousel_review" %}
                {% assign manual_count = manual_count | plus: 1 %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if block.settings.image %}
                          <img
                            src='{{ block.settings.image | image_url: width: 400 }}'
                            alt='{{ block.settings.product_title | default: block.settings.author }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                        <div class='flex items-center mb-3 md:mb-4'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= block.settings.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- block.settings.rating }}/5</span
                          >
                        </div>
                        <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                          "{{ block.settings.review_text }}"
                        </blockquote>
                        <div class='flex items-center'>
                          <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                            <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                              {{-
                                block.settings.author
                                | slice: 0, 1
                                | upcase
                              -}}
                            </span>
                          </div>
                          <div>
                            <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                              {{- block.settings.author -}}
                            </cite>
                            <p class='text-xs md:text-sm text-gray-500'>
                              {{ block.settings.product_title }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endif %}
            {% endfor %}
            {% if manual_count == 0 %}
              <!-- Placeholder slide shown when no manual slides are added -->
              <swiper-slide>
                <div
                  class='bg-white rounded-lg shadow-lg overflow-hidden'
                  style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                >
                  <div class='flex flex-col md:flex-row h-auto md:h-80'>
                    <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                      {{
                        "product-1"
                        | placeholder_svg_tag: "w-full h-full bg-gray-200 object-cover"
                      }}
                    </div>
                    <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                      <div class='flex items-center mb-3 md:mb-4'>
                        <div class='flex text-yellow-400 mr-3'>
                          {% for i in (1..5) %}
                            <svg
                              class='w-4 h-4 md:w-5 md:h-5 fill-current'
                              viewBox='0 0 20 20'
                            >
                              <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                            </svg>
                          {% endfor %}
                        </div>
                        <span class='text-xs md:text-sm text-gray-600 font-medium'
                          >5/5</span
                        >
                      </div>
                      <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                        "Add your first review in the theme editor."
                      </blockquote>
                      <div class='flex items-center'>
                        <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                          <span class='text-gray-600 font-semibold text-xs md:text-sm'
                            >A</span
                          >
                        </div>
                        <div>
                          <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'
                            >Anonymous</cite
                          >
                          <p class='text-xs md:text-sm text-gray-500'>
                            Product Name
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </swiper-slide>
            {% endif %}
          {% endunless %}
        </swiper-container>
      </div>
    {% endif %}

    <!-- Swiper Styles -->
    <style>
      .testimonials-carousel {
        width: 100%;
        height: auto;
        min-height: 300px;
      }

      @media (min-width: 768px) {
        .testimonials-carousel {
          height: 400px;
        }
      }

      .testimonials-carousel swiper-slide {
        text-align: center;
        font-size: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .testimonials-carousel swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Custom Pagination Styles */
      .testimonials-carousel .swiper-pagination {
        position: relative !important;
        bottom: 0 !important;
        margin-top: 20px;
      }

      .testimonials-carousel .swiper-pagination-bullet {
        background: rgba(0, 0, 0, 0.5);
        opacity: 1;
        width: 12px;
        height: 12px;
        margin: 0 4px;
      }

      .testimonials-carousel .swiper-pagination-bullet-active {
        background: #3b82f6;
      }
    </style>

    <!-- Quote Collapse Styles -->
    <style>
      .quote-base {
        display: block;
      }
      .quote-base.quote-collapsed .js-quote-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .quote-base.quote-expanded .js-quote-text {
        display: block;
      }

      .modal-quote {
        max-height: 2rem;
        overflow: hidden;
      }
      .modal-quote--expanded {
        max-height: none;
      }
      @media (min-width: 768px) {
        .modal-quote {
          max-height: 4rem;
        }
      }

      /* Force small typography and clamp on mobile to avoid reflow conflicts */
      @media (max-width: 767px) {
        .testimonial-modal-quote {
          font-size: 12px !important;
          line-height: 1.35 !important;
          max-height: 2.7rem !important; /* ~2 lines */
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
        .testimonial-modal-quote.modal-quote--expanded {
          -webkit-line-clamp: unset;
          max-height: none !important;
          display: block;
        }
        .testimonial-modal-content {
          padding: 0.5rem !important;
        }
        .testimonial-modal-author {
          font-size: 12px !important;
          line-height: 1.25 !important;
        }
        .testimonial-modal-toggle {
          font-size: 11px !important;
          line-height: 1.1 !important;
        }
      }

      /* Remove default blockquote styling and tighten vertical rhythm */
      .testimonial-modal-quote {
        margin: 0 0 0.35rem !important;
        padding: 0 !important;
        border: none !important;
      }
      .testimonial-modal-toggle {
        margin: 0 !important;
        padding: 0 !important;
      }
      .testimonial-modal-author {
        margin: 0 !important;
      }

      /* Carousel review text clamp + scroll */
      .carousel-review-text {
        margin-bottom: 0.5rem;
      }
      .carousel-review-quote {
        position: relative;
        padding-right: 1.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .carousel-review-text.is-expanded .carousel-review-quote {
        display: block;
        -webkit-line-clamp: unset;
        overflow: visible;
      }
      .carousel-review-text.is-truncated:not(.is-expanded) .carousel-review-quote::after {
        position: absolute;
        right: 0;
        bottom: 0;
        padding-left: 0.25rem;
        background: #ffffff;
      }
      .carousel-review-footer {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 1rem;
      }
      .carousel-review-quote {
        margin-bottom: 0.5rem;
      }
      .carousel-review-content.is-expanded .carousel-review-stars {
        display: none;
      }
      .carousel-review-stars-inline {
        display: none;
      }
      .carousel-review-content.is-expanded .carousel-review-stars-inline {
        display: inline-flex;
      }
      .carousel-review-close {
        margin-left: auto;
        font-size: 0.75rem;
        line-height: 1.2;
        text-decoration: underline;
        color: #2563eb;
        background: transparent;
        border: 0;
        padding: 0;
        cursor: pointer;
        display: none;
      }
      .carousel-review-content.is-expanded .carousel-review-close {
        display: inline-flex;
      }
      .carousel-review-content.is-expanded .carousel-review-toggle {
        display: none;
      }
      .carousel-review-toggle {
        margin-left: auto;
        font-size: 0.75rem;
        line-height: 1.2;
        text-decoration: underline;
        color: #2563eb;
        background: transparent;
        border: 0;
        padding: 0;
        cursor: pointer;
      }
      .carousel-review-toggle[hidden] {
        display: none !important;
      }
      @media (max-width: 767px) {
        .carousel-review-quote {
          -webkit-line-clamp: 2;
        }
        .carousel-review-footer {
          flex-wrap: wrap;
          row-gap: 0.5rem;
        }
      }
    </style>

    <!-- Initialize Swiper -->
    <script>
      // Wait for Swiper web components to be defined since it's loaded with defer
      document.addEventListener('DOMContentLoaded', function () {
        const initCarousels = () => {
          document
            .querySelectorAll('.testimonials-carousel')
            .forEach((el, index) => {
              if (el && el.swiper) {
                console.log(`Carousel ${index} already initialized`)
                return
              }
              if (typeof el.initialize === 'function') {
                // Count slides before initializing
                const slides = el.querySelectorAll('swiper-slide')
                console.log(`Carousel ${index} has ${slides.length} slides`)

                // Only enable loop if there are multiple slides
                if (slides.length > 1) {
                  el.setAttribute('loop', 'true')
                  console.log(
                    `Enabled loop for carousel ${index} (${slides.length} slides)`
                  )
                } else {
                  el.setAttribute('loop', 'false')
                  console.log(
                    `Disabled loop for carousel ${index} (${slides.length} slides)`
                  )
                }

                el.initialize()
                console.log(`Testimonials carousel ${index} initialized`)

                // Check if pagination is working
                setTimeout(() => {
                  const pagination = el.querySelector('.swiper-pagination')
                  console.log('Pagination element:', pagination)
                  if (pagination) {
                    console.log('Pagination found and should be visible')
                  } else {
                    console.log(
                      'Pagination not found - this might be the issue'
                    )
                  }
                }, 100)
              } else {
                console.log(
                  `Carousel ${index} initialize function not available yet`
                )
              }
            })
        }

        // Try immediately, then retry after a short delay if needed
        initCarousels()
        setTimeout(initCarousels, 200)
        setTimeout(initCarousels, 500) // Extra retry
      })
    </script>

    <!-- Truncate Quotes to Consistent Preview Length with Read More Toggle -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Target only the testimonial card overlays, not the modal
        const quoteBlocks = document.querySelectorAll(
          'blockquote[data-truncate="quote"]'
        )
        const MAX_WORDS = 22
        const MAX_CHARS = 160

        quoteBlocks.forEach(el => {
          const fullTextRaw = (el.textContent || '').trim()
          if (!fullTextRaw) return

          // Remove surrounding quotes injected by Liquid
          const fullText = fullTextRaw.replace(/^"+|"+$/g, '')
          const words = fullText.split(/\s+/)
          const needsTruncate =
            words.length > MAX_WORDS || fullText.length > MAX_CHARS

          el.classList.add('quote-base')

          if (!needsTruncate) {
            el.textContent = `"${fullText}"`
            return
          }

          const truncatedWords = words.slice(0, MAX_WORDS).join(' ')
          let truncated = truncatedWords

          if (truncated.length > MAX_CHARS) {
            const trimmed = truncated.slice(0, MAX_CHARS)
            const lastSpace = trimmed.lastIndexOf(' ')
            truncated = lastSpace > 0 ? trimmed.slice(0, lastSpace) : trimmed
          }

          truncated = truncated.replace(/[\s,.!?;:-]+$/, '')
          const collapsedText = `${truncated}â€¦`

          const textSpan = document.createElement('span')
          textSpan.className = 'js-quote-text'
          textSpan.textContent = `"${collapsedText}"`

          const toggleBtn = document.createElement('button')
          toggleBtn.type = 'button'
          toggleBtn.className =
            'ml-1 underline text-blue-300 js-quote-toggle focus:outline-none'
          toggleBtn.textContent = 'Read more'
          toggleBtn.setAttribute('aria-expanded', 'false')

          toggleBtn.addEventListener('click', function (e) {
            e.preventDefault()
            e.stopPropagation()
            const expanded = el.classList.contains('quote-expanded')

            if (expanded) {
              el.classList.remove('quote-expanded')
              el.classList.add('quote-collapsed')
              textSpan.textContent = `"${collapsedText}"`
              toggleBtn.textContent = 'Read more'
              toggleBtn.setAttribute('aria-expanded', 'false')
            } else {
              el.classList.remove('quote-collapsed')
              el.classList.add('quote-expanded')
              textSpan.textContent = `"${fullText}"`
              toggleBtn.textContent = 'Show less'
              toggleBtn.setAttribute('aria-expanded', 'true')
            }
          })

          el.innerHTML = ''
          el.appendChild(textSpan)
          el.appendChild(toggleBtn)
          el.classList.add('quote-collapsed')
        })
      })
    </script>

    <!-- Carousel review text toggle -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const reviewBlocks = document.querySelectorAll('.carousel-review-text')

        reviewBlocks.forEach(block => {
          const quote = block.querySelector('.carousel-review-quote')
          const content = block.closest('.carousel-review-content')
          const toggle = content ? content.querySelector('.carousel-review-toggle') : null
          const closeBtn = content ? content.querySelector('.carousel-review-close') : null
          if (!quote || !toggle) return

          const setCollapsed = () => {
            block.classList.remove('is-expanded')
            if (content) {
              content.classList.remove('is-expanded')
            }
            toggle.textContent = 'Read more'
            toggle.setAttribute('aria-expanded', 'false')
          }

          const updateToggleVisibility = () => {
            setCollapsed()
            const needsToggle = quote.scrollHeight > quote.clientHeight + 1
            if (!needsToggle) {
              toggle.setAttribute('hidden', 'true')
              block.classList.remove('is-truncated')
              return
            }
            toggle.removeAttribute('hidden')
            block.classList.add('is-truncated')
          }

          toggle.addEventListener('click', function (e) {
            e.preventDefault()
            const expanded = block.classList.toggle('is-expanded')
            if (content) {
              content.classList.toggle('is-expanded', expanded)
            }
            block.classList.toggle('is-truncated', !expanded)
            toggle.textContent = expanded ? 'Show less' : 'Read more'
            toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false')
          })

          if (closeBtn) {
            closeBtn.addEventListener('click', function (e) {
              e.preventDefault()
              block.classList.remove('is-expanded')
              if (content) {
                content.classList.remove('is-expanded')
              }
              block.classList.add('is-truncated')
              toggle.textContent = 'Read more'
              toggle.setAttribute('aria-expanded', 'false')
            })
          }

          requestAnimationFrame(updateToggleVisibility)
          window.addEventListener('resize', updateToggleVisibility)
        })
      })
    </script>

    <!-- Remaining Testimonials (after first 2 desktop rows) -->
    {% assign testimonial_total = 0 %}
    {% for block in section.blocks %}
      {% if block.type == "testimonial" %}
        {% assign testimonial_total = testimonial_total | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if testimonial_total > break_count %}
      <div class='mt-8'>
        <style>
          .testimonials-grid-remaining {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat({{ mobile_cols }}, minmax(0, 1fr));
          }
          @media (min-width: 768px) {
            .testimonials-grid-remaining {
              grid-template-columns: repeat({{ desktop_cols }}, minmax(0, 1fr));
            }
          }
        </style>
        <div class='testimonials-grid-remaining'>
          {% assign testimonial_index = 0 %}
          {% for block in section.blocks %}
            {% if block.type == "testimonial" %}
              {% assign testimonial_index = testimonial_index | plus: 1 %}
              {% if testimonial_index > break_count %}
                {% assign has_image = block.settings.author_image %}
                {% if has_image %}
                  {% assign img_ratio = has_image.aspect_ratio | default: 1 %}
                {% endif %}
                <div
                  class='relative w-full rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer testimonial-card'
                  {% if has_image %}
                    style='aspect-ratio: {{ img_ratio }};'
                  {% else %}
                    style='min-height: 25rem;'
                  {% endif %}
                  data-quote='{{ block.settings.quote | strip_newlines | escape }}'
                  data-author='{{ block.settings.author | escape }}'
                  data-image='{% if has_image %}{{ has_image | image_url: width: 2000 | escape }}{% endif %}'
                  onclick='(function(el){window.dispatchEvent(new CustomEvent("open-testimonial",{detail:{quote:el.getAttribute("data-quote"),author:el.getAttribute("data-author"),author_image:el.getAttribute("data-image")||null}}))})(this)'
                >
                  <!-- Background Image -->
                  {% if has_image %}
                    {% assign fit = block.settings.object_fit
                      | default: "cover"
                    %}
                    {% assign pos = block.settings.object_position
                      | default: "center"
                    %}
                    {% assign pos_map = "top:50%_0%,center:50%_50%,bottom:50%_100%"
                      | split: ","
                    %}
                    {% assign pos_css = "50%_50%" %}
                    {% for pair in pos_map %}
                      {% assign kv = pair | split: ":" %}
                      {% if kv[0] == pos -%}
                        {%- assign pos_css = kv[1] -%}
                      {%- endif %}
                    {% endfor %}
                    {% assign img_width = has_image.width | default: 400 %}
                    {% assign img_height = has_image.height | default: 400 %}
                    <img
                      src='{{ has_image | image_url: width: 800 }}'
                      alt='Photo of {{ block.settings.author }}'
                      width='{{ img_width }}'
                      height='{{ img_height }}'
                      loading='lazy'
                      style='width:100%;height:100%;object-fit:{{ fit }};object-position:{{ pos_css | replace: "_", " " }};'
                    >
                  {% else %}
                    <div class='w-full h-full bg-gray-300 flex items-center justify-center'>
                      <span class='text-gray-500 text-sm'>No image</span>
                    </div>
                  {% endif %}

                  <!-- Content Overlay with Background -->
                  <div class='absolute bottom-0 left-0 right-0 text-white bg-black/60 flex flex-col gap-0 testimonial-card__overlay'>
                    <!-- Quote -->
                    <blockquote
                      class='testimonial-card__quote text-white italic'
                      data-truncate='quote'
                    >
                      "{{ block.settings.quote }}"
                    </blockquote>

                    <!-- Author Name -->
                    <cite class='testimonial-card__author text-white font-semibold not-italic'>
                      {{ block.settings.author }}
                    </cite>
                  </div>
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!--
      Product Reviews Carousel (moved below grids so cards fill rows first)
    -->
    {% if false
      and section.settings.enable_carousel
      and section.blocks.size > 8
    %}
      <div
        class='mt-16'
        style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
      >
        {% if section.settings.show_carousel_title %}
          <h3 class='text-2xl font-bold text-gray-900 text-center mb-8'>
            {{ section.settings.carousel_title }}
          </h3>
        {% endif %}

        <!-- Swiper Carousel -->
        <swiper-container
          class='testimonials-carousel'
          pagination='true'
          pagination-clickable='true'
          navigation='false'
          space-between='20'
          slides-per-view='1'
          centered-slides='true'
          autoplay='true'
          autoplay-delay='5000'
          autoplay-disable-on-interaction='false'
          loop='false'
        >
          {% assign has_reviews = false %}
          {% for product in collections.all.products %}
            {% if product.reviews.size > 0 %}
              {% assign has_reviews = true %}
              {% for review in product.reviews %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if product.featured_image %}
                          <img
                            src='{{ product.featured_image | image_url: width: 400 }}'
                            alt='{{ product.title }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                        <div class='flex items-center mb-3 md:mb-4'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= review.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- review.rating }}/5</span
                          >
                        </div>
                        <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                          "{{ review.content }}"
                        </blockquote>
                        <div class='flex items-center'>
                          <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                            <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                              {{- review.author | slice: 0, 1 | upcase -}}
                            </span>
                          </div>
                          <div>
                            <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                              {{- review.author -}}
                            </cite>
                            <p class='text-xs md:text-sm text-gray-500'>
                              {{ product.title }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endfor %}
            {% endif %}
          {% endfor %}

          {% unless has_reviews %}
            {% assign manual_count = 0 %}
            {% for block in section.blocks %}
              {% if block.type == "carousel_review" %}
                {% assign manual_count = manual_count | plus: 1 %}
                <swiper-slide>
                  <div
                    class='bg-white rounded-lg shadow-lg overflow-hidden'
                    style='max-width: {{ section.settings.carousel_max_width | default: 1200 }}px; margin-left: auto; margin-right: auto;'
                  >
                    <div class='flex flex-col md:flex-row h-auto md:h-80'>
                      <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                        {% if block.settings.image %}
                          <img
                            src='{{ block.settings.image | image_url: width: 400 }}'
                            alt='{{ block.settings.product_title | default: block.settings.author }}'
                            width='400'
                            height='400'
                            class='w-full h-full object-cover'
                          >
                        {% else %}
                          <div class='w-full h-full bg-gray-200 flex items-center justify-center'>
                            <span class='text-gray-500'>No image</span>
                          </div>
                        {% endif %}
                      </div>
                      <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                        <div class='flex items-center mb-3 md:mb-4'>
                          <div class='flex text-yellow-400 mr-3'>
                            {% for i in (1..5) %}
                              {% if i <= block.settings.rating %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 fill-current'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% else %}
                                <svg
                                  class='w-4 h-4 md:w-5 md:h-5 text-gray-300'
                                  viewBox='0 0 20 20'
                                >
                                  <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                                </svg>
                              {% endif %}
                            {% endfor %}
                          </div>
                          <span class='text-xs md:text-sm text-gray-600 font-medium'>
                            {{- block.settings.rating }}/5</span
                          >
                        </div>
                        <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                          "{{ block.settings.review_text }}"
                        </blockquote>
                        <div class='flex items-center'>
                          <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                            <span class='text-gray-600 font-semibold text-xs md:text-sm'>
                              {{-
                                block.settings.author
                                | slice: 0, 1
                                | upcase
                              -}}
                            </span>
                          </div>
                          <div>
                            <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'>
                              {{- block.settings.author -}}
                            </cite>
                            <p class='text-xs md:text-sm text-gray-500'>
                              {{ block.settings.product_title }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </swiper-slide>
              {% endif %}
            {% endfor %}
            {% if manual_count == 0 %}
              <!-- Placeholder Review (no product reviews, no manual slides) -->
              <swiper-slide>
                <div class='bg-white rounded-lg shadow-lg overflow-hidden mx-auto max-w-5xl'>
                  <div class='flex flex-col md:flex-row h-auto md:h-80'>
                    <div class='w-full md:w-1/2 relative h-48 md:h-full'>
                      {{
                        "product-1"
                        | placeholder_svg_tag: "w-full h-full bg-gray-200 object-cover"
                      }}
                    </div>
                    <div class='w-full md:w-1/2 p-4 md:p-8 flex flex-col justify-center'>
                      <div class='flex items-center mb-3 md:mb-4'>
                        <div class='flex text-yellow-400 mr-3'>
                          {% for i in (1..5) %}
                            <svg
                              class='w-4 h-4 md:w-5 md:h-5 fill-current'
                              viewBox='0 0 20 20'
                            >
                              <path d='M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z'/>
                            </svg>
                          {% endfor %}
                        </div>
                        <span class='text-xs md:text-sm text-gray-600 font-medium'
                          >5/5</span
                        >
                      </div>
                      <blockquote class='text-gray-800 text-sm md:text-lg leading-relaxed mb-4 md:mb-6 italic'>
                        "Add your first review in the theme editor."
                      </blockquote>
                      <div class='flex items-center'>
                        <div class='w-8 h-8 md:w-12 md:h-12 bg-gray-300 rounded-full mr-3 md:mr-4 flex items-center justify-center'>
                          <span class='text-gray-600 font-semibold text-xs md:text-sm'
                            >A</span
                          >
                        </div>
                        <div>
                          <cite class='text-gray-900 font-semibold not-italic text-sm md:text-base block'
                            >Anonymous</cite
                          >
                          <p class='text-xs md:text-sm text-gray-500'>
                            Product Name
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </swiper-slide>
            {% endif %}
          {% endunless %}
        </swiper-container>
      </div>
    {% endif %}

    <!-- Empty State -->
    {% if section.blocks.size == 0 %}
      <div class='text-center py-12'>
        <p class='text-gray-500 text-lg'>
          No testimonials added yet. Add some testimonials in the theme editor.
        </p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Testimonial Modal -->
<div
  x-data='testimonialModal()'
  x-show='isOpen'
  x-transition:enter='transition ease-out duration-300'
  x-transition:enter-start='opacity-0'
  x-transition:enter-end='opacity-100'
  x-transition:leave='transition ease-in duration-200'
  x-transition:leave-start='opacity-100'
  x-transition:leave-end='opacity-0'
  class='fixed inset-0 z-50 flex items-center justify-center bg-black/60 bg-opacity-75'
  @click.self='closeModal()'
  style='display: none;'
>
  <div
    class='relative max-w-4xl max-h-[90vh] w-full mx-4 rounded-lg overflow-hidden'
    x-transition:enter='transition ease-out duration-300'
    x-transition:enter-start='opacity-0 scale-95'
    x-transition:enter-end='opacity-100 scale-100'
    x-transition:leave='transition ease-in duration-200'
    x-transition:leave-start='opacity-100 scale-100'
    x-transition:leave-end='opacity-0 scale-95'
  >
    <!-- Close Button -->
    <button
      @click='closeModal()'
      class='absolute top-4 right-4 z-10 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 transition-colors'
    >
      <svg
        class='w-6 h-6'
        fill='none'
        stroke='currentColor'
        viewBox='0 0 24 24'
      >
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path>
      </svg>
    </button>

    <!-- Modal Content -->
    <div class='flex flex-col h-full'>
      <!-- Full Image -->
      <div class='relative'>
        <template x-if='selectedTestimonial && selectedTestimonial.author_image'>
          <img
            :src='selectedTestimonial.author_image'
            :alt='`Photo of ${selectedTestimonial.author}`'
            width='1200'
            height='800'
            :style='`width:100%;height:100%;object-fit:${selectedTestimonial.object_fit||"cover"};object-position:${(selectedTestimonial.object_position||"center")==="top"?"50% 0%":(selectedTestimonial.object_position||"center")==="bottom"?"50% 100%":"50% 50%"};`'
          >
        </template>
        <template x-if='!selectedTestimonial || !selectedTestimonial.author_image'>
          <div class='w-full h-full bg-gray-300 flex items-center justify-center'>
            <span class='text-gray-500 text-lg'>No image</span>
          </div>
        </template>
      </div>

      <!-- Review Content -->
      <div class='p-2 md:p-6 bg-black/40 absolute bottom-0 left-0 right-0 testimonial-modal-content'>
        <div class='text-left max-w-4xl mx-auto'>
          <blockquote
            class='text-white text-xs md:text-xl leading-snug md:leading-relaxed mb-[2px] italic modal-quote testimonial-modal-quote'
            :class="{ 'modal-quote--expanded': modalExpanded }"
          >
            <span
              class='block text-white'
              x-text='modalExpanded ? modalFullTextDisplay : modalCollapsedText'
            ></span>
          </blockquote>
          <div x-show='modalToggleVisible && !modalExpanded' class='mt-[2px] mb-1'>
            <button
              type='button'
              class='text-white underline text-[11px] md:text-sm focus:outline-none testimonial-modal-toggle leading-none'
              @click='toggleModalQuote()'
            >
              Read more
            </button>
          </div>
          <div class='flex items-center justify-between gap-3'>
            <cite
              class='text-white font-semibold not-italic text-xs md:text-lg block leading-snug testimonial-modal-author'
              style='line-height: 1.25; color: #fff;'
            >
              <span
                x-text='selectedTestimonial ? selectedTestimonial.author : ""'
              ></span>
            </cite>
            <button
              type='button'
              x-show='modalToggleVisible && modalExpanded'
              class='text-white underline text-[11px] md:text-sm focus:outline-none testimonial-modal-toggle leading-none'
              @click='toggleModalQuote()'
            >
              Show less
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Alpine.js Modal Functionality -->
<script>
  window.decodeHtmlEntities = function (str) {
    if (!str) return str
    const txt = document.createElement('textarea')
    txt.innerHTML = str
    return txt.value
  }

  function testimonialModal() {
    return {
      isOpen: false,
      selectedTestimonial: null,
      modalExpanded: false,
      modalCollapsedText: '',
      modalFullTextDisplay: '',
      modalToggleVisible: false,

      openModal(testimonial) {
        this.selectedTestimonial = testimonial
        this.isOpen = true
        document.body.style.overflow = 'hidden'

        const fullRaw = testimonial && testimonial.quote ? String(testimonial.quote).trim() : ''
        const { collapsed, full, needsToggle } = this.truncateQuote(fullRaw)
        this.modalCollapsedText = collapsed
        this.modalFullTextDisplay = full
        this.modalToggleVisible = needsToggle
        this.modalExpanded = false
      },

      closeModal() {
        this.isOpen = false
        this.selectedTestimonial = null
        document.body.style.overflow = 'auto'
      },

      toggleModalQuote() {
        this.modalExpanded = !this.modalExpanded
      },

      truncateQuote(text) {
        const MAX_WORDS = 22
        const MAX_CHARS = 160
        const safe = (text || '').trim()
        const fullDisplay = `"${safe}"`
        if (!safe) {
          return { collapsed: '', full: '', needsToggle: false }
        }

        const words = safe.split(/\s+/)
        const needsTruncate = words.length > MAX_WORDS || safe.length > MAX_CHARS
        if (!needsTruncate) {
          return { collapsed: fullDisplay, full: fullDisplay, needsToggle: false }
        }

        let truncated = words.slice(0, MAX_WORDS).join(' ')
        if (truncated.length > MAX_CHARS) {
          const trimmed = truncated.slice(0, MAX_CHARS)
          const lastSpace = trimmed.lastIndexOf(' ')
          truncated = lastSpace > 0 ? trimmed.slice(0, lastSpace) : trimmed
        }
        truncated = truncated.replace(/[\s,.!?;:-]+$/, '')
        const collapsed = `"${truncated}â€¦"`
        return { collapsed, full: fullDisplay, needsToggle: true }
      },
      init() {
        window.addEventListener('open-testimonial', e => {
          this.openModal(e.detail)
        })
      },
    }
  }
</script>
