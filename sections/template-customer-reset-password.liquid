<div
  class='min-h-screen flex items-center justify-center px-6 py-12'
  x-data='resetPasswordForm()'
>
  <div class='w-full max-w-md'>
    <!-- Brand Logo/Name -->
    <div class='text-center mb-8'>
      <a href='{{ routes.root_url }}' class='inline-block'>
        {% if section.settings.logo_image
          and section.settings.logo_image != blank
        %}
          <img
            src='{{ section.settings.logo_image | image_url: width: 200 }}'
            alt='{{ section.settings.shop_name }} Logo'
            class='h-28 mx-auto'
          >
        {% elsif "logo.png" %}
          <img
            src='{{ "logo.png" | asset_url }}'
            alt='{{ section.settings.shop_name }} Logo'
            class='h-28 mx-auto'
          >
        {% else %}
          <h1 class='text-3xl font-bold text-gray-900'>
            {{ section.settings.shop_name }}
          </h1>
        {% endif %}
      </a>
    </div>

    <!-- Reset Password Form -->
    <div class='mb-8'>
      <h2 class='text-2xl font-bold text-gray-900 mb-2'>Reset your password</h2>
      <p class='text-gray-600'>Enter your new password below</p>
    </div>

    <!-- Success Message -->
    <div
      x-show='showSuccess'
      x-transition
      class='mb-6 p-4 bg-green-50 border border-green-200 rounded-lg'
    >
      <div class='flex'>
        <div class='flex-shrink-0'>
          <svg
            class='h-5 w-5 text-green-400'
            viewBox='0 0 20 20'
            fill='currentColor'
          >
            <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd' />
          </svg>
        </div>
        <div class='ml-3'>
          <h3 class='text-sm font-medium text-green-800'>
            Password Reset Successful!
          </h3>
          <div class='mt-2 text-sm text-green-700'>
            Your password has been successfully reset. You can now sign in with
            your new password.
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div
      x-show='showError'
      x-transition
      class='mb-6 p-4 bg-red-50 border border-red-200 rounded-lg'
    >
      <div class='flex'>
        <div class='flex-shrink-0'>
          <svg
            class='h-5 w-5 text-red-400'
            viewBox='0 0 20 20'
            fill='currentColor'
          >
            <path fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z' clip-rule='evenodd' />
          </svg>
        </div>
        <div class='ml-3'>
          <h3 class='text-sm font-medium text-red-800'>Error</h3>
          <div class='mt-2 text-sm text-red-700' x-text='errorMessage'></div>
        </div>
      </div>
    </div>

    <form x-on:submit.prevent='submitForm' novalidate>
      <div class='space-y-4'>
        <div>
          <label
            for='password'
            class='block text-sm font-medium text-gray-700 mb-1'
          >
            New Password
          </label>
          <input
            type='password'
            x-model='password'
            id='password'
            autocomplete='new-password'
            class='w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black focus:border-black'
            placeholder='Enter your new password'
            required
          >
        </div>

        <div>
          <label
            for='password_confirmation'
            class='block text-sm font-medium text-gray-700 mb-1'
          >
            Confirm Password
          </label>
          <input
            type='password'
            x-model='passwordConfirmation'
            id='password_confirmation'
            autocomplete='new-password'
            class='w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-black focus:border-black'
            placeholder='Confirm your new password'
            required
          >
        </div>
      </div>

      <div class='mt-6'>
        <button
          type='submit'
          x-bind:disabled='isSubmitting'
          class='w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed'
        >
          <span x-show='!isSubmitting'>Reset Password</span>
          <span
            x-show='isSubmitting'
            class='flex items-center justify-center gap-2'
          >
            <svg class='animate-spin h-4 w-4' fill='none' viewBox='0 0 24 24'>
              <circle class='opacity-25' cx='12' cy='12' r='10' stroke='currentColor' stroke-width='4'></circle>
              <path class='opacity-75' fill='currentColor' d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'></path>
            </svg>
            Resetting...
          </span>
        </button>
      </div>
    </form>

    <div class='mt-6 text-center'>
      <p class='text-gray-600'>
        Remember your password?
        <a
          href='{{ routes.account_login_url }}'
          class='text-blue-600 hover:text-blue-500 font-medium'
        >
          Sign in
        </a>
      </p>
    </div>
  </div>
</div>

<script>
  function resetPasswordForm() {
    return {
      password: '',
      passwordConfirmation: '',
      isSubmitting: false,
      showSuccess: false,
      showError: false,
      errorMessage: '',

      async submitForm() {
        // Reset messages
        this.showSuccess = false
        this.showError = false
        this.errorMessage = ''

        // Validate passwords match
        if (this.password !== this.passwordConfirmation) {
          this.showError = true
          this.errorMessage = 'Passwords do not match.'
          return
        }

        // Validate password length
        if (this.password.length < 6) {
          this.showError = true
          this.errorMessage = 'Password must be at least 6 characters long.'
          return
        }

        this.isSubmitting = true

        try {
          const formData = new FormData()
          formData.append('form_type', 'reset_customer_password')
          formData.append('customer[password]', this.password)
          formData.append(
            'customer[password_confirmation]',
            this.passwordConfirmation
          )

          const response = await fetch('/account/reset', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          })

          if (response.ok) {
            this.showSuccess = true
            this.password = ''
            this.passwordConfirmation = ''

            // Redirect to login page after 3 seconds
            setTimeout(() => {
              window.location.href = '{{ routes.account_login_url }}'
            }, 3000)
          } else {
            const text = await response.text()
            this.showError = true
            this.errorMessage =
              'There was an error resetting your password. Please try again.'
          }
        } catch (error) {
          console.error('Form submission error:', error)
          this.showError = true
          this.errorMessage =
            'There was an error resetting your password. Please try again.'
        } finally {
          this.isSubmitting = false
        }
      },
    }
  }
</script>

{% schema %}
{
  "name": "Customer Reset Password",
  "settings": [
    {
      "type": "text",
      "id": "shop_name",
      "label": "Shop Name",
      "default": "Kestrel Knives"
    },
    {
      "type": "image_picker",
      "id": "logo_image",
      "label": "Logo Image"
    }
  ],
  "presets": [
    {
      "name": "Customer Reset Password",
      "settings": {
        "shop_name": "Kestrel Knives"
      }
    }
  ]
}
{% endschema %}
