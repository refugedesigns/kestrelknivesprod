{% if product and product.selected_or_first_available_variant %}
  {% assign selected_variant = product.selected_or_first_available_variant %}
{% elsif product and product.variants and product.variants.size > 0 %}
  {% assign selected_variant = product.variants.first %}
{% else %}
  {% assign selected_variant = null %}
{% endif %}

<style>
  /* Custom styles for enhanced functionality */
  html {
    scroll-behavior: smooth;
  }

  /* Image transition effects */
  .image-transition {
    transition: opacity 0.3s ease-in-out;
  }

  /* Button hover effects */
  .button-hover-scale {
    transition: transform 0.2s ease-in-out;
  }

  .button-hover-scale:hover {
    transform: scale(1.02);
  }

  .button-hover-scale:active {
    transform: scale(0.98);
  }

  /* Color selection hover effects */
  .color-option {
    transition: all 0.2s ease-in-out;
  }

  .color-option:hover {
    transform: translateY(-2px);
  }

  /* Quantity input styling */
  input[type='number']::-webkit-outer-spin-button,
  input[type='number']::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type='number'] {
    -moz-appearance: textfield;
  }

  /* Focus states for accessibility */
  button:focus-visible,
  input:focus-visible {
    outline: 2px solid #ff6b35;
    outline-offset: 2px;
  }

  /* Responsive image container */
  .aspect-square {
    aspect-ratio: 1 / 1;
  }

  /* Mobile sticky positioning */
  @media (max-width: 1024px) {
    .mobile-sticky {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: white;
      border-top: 1px solid #e5e7eb;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
    }
  }

  /* Responsive star sizing */
  .review-stars {
    width: {{ section.settings.star_size_mobile | default: 16 }}px;
    height: {{ section.settings.star_size_mobile | default: 16 }}px;
  }

  @media (min-width: 768px) {
    .review-stars {
      width: {{ section.settings.star_size_desktop | default: 20 }}px;
      height: {{ section.settings.star_size_desktop | default: 20 }}px;
    }
  }
</style>

<div class='bg-gray-50 mb-8' x-data='productPage()'>
  <!-- Main Product Section -->
  <main class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-28'>
    <div class='lg:grid lg:grid-cols-12 lg:gap-12'>
      <!-- Left Column - Product Images -->
      <div class='lg:col-span-7'>
        <!-- Main Image -->
        <div class='aspect-square bg-white rounded-lg overflow-hidden mb-6 relative group'>
          <img
            id='mainImage'
            src='{{ product.featured_image | img_url: '600x600' }}'
            alt='{{ product.title | escape }}'
            class='w-full h-full object-contain transition-transform group-hover:scale-105'
          >

          <!-- Magnifying Glass Button -->
          <button
            @click='openGallery()'
            class='absolute top-4 right-4 bg-white/90 hover:bg-white rounded-full p-3 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg'
          >
            <svg
              class='w-5 h-5'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </button>

          <!-- Navigation Arrows -->
          <button
            @click='previousImage()'
            class='absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full p-3 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg'
          >
            <svg
              class='w-5 h-5'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button
            @click='nextImage()'
            class='absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white rounded-full p-3 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg'
          >
            <svg
              class='w-5 h-5'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>

        <!-- Thumbnail Images -->
        <div id='thumbnailStrip' class='flex space-x-4 overflow-x-auto pb-2'>
          {% for media in product.media %}
            <button
              @click='changeImage({{ forloop.index0 }})'
              class='thumbnail flex-shrink-0 w-20 h-20 bg-gray-50 rounded-lg overflow-hidden border-2 {% if forloop.first %}border-black{% else %}border-gray-200 hover:border-black{% endif %} transition-colors'
            >
              {% render "product-media", media: media %}
            </button>
          {% endfor %}
        </div>
      </div>

      <!-- Right Column - Product Info -->
      <div class='lg:col-span-5 mt-8 lg:mt-0'>
        <div class='lg:sticky lg:top-24'>
          <!-- Brand -->
          <p class='text-sm text-gray-500 mb-2'>{{ product.vendor }}</p>

          <!-- Product Title -->
          <h1 class='text-4xl font-bold text-gray-900 mb-6'>
            {{ product.title }}
          </h1>

          {% form "product",
            product,
            id: "product-form",
            novalidate: "novalidate"
          %}
            <input
              type='hidden'
              name='id'
              id='variantIdInput'
              value='{{ selected_variant.id }}'
            >

            <!-- Price -->
            <div class='mb-8'>
              <span
                id='price'
                class='text-3xl font-bold text-gray-900'
                data-base-price-cents='0'
              >
                {{ 0 | money }}
              </span>
              <span
                id='comparePrice'
                class='text-lg text-gray-500 line-through ml-2'
                style='display: {% if selected_variant.compare_at_price > selected_variant.price %}inline-block{% else %}none{% endif %};'
              >
                {{- selected_variant.compare_at_price | money -}}
              </span>
              <span
                id='saleBadge'
                class='px-3 py-1 text-sm font-bold bg-red-500 rounded-full text-white ml-4'
                style='display: {% if selected_variant.compare_at_price > selected_variant.price %}inline-block{% else %}none{% endif %};'
                >Sale</span
              >
              <div id='availability' class='mt-1 text-sm text-gray-600'></div>
            </div>

            <!-- Shop Pay installments banner -->
            <div class='mb-6'>
              <p class='text-md text-gray-500'>
                {{ form | payment_terms }}
              </p>
            </div>

            {% if section.settings.use_custom_variants %}
              <!-- Custom Variant Options -->
              <div id='custom-options'>
                {% assign groups = section.blocks %}
                {% for block in section.blocks %}
                  {% if block.type == "custom_option_group" %}
                    <div class='mb-6'>
                      <h3 class='text-lg font-semibold mb-3'>
                        {{ block.settings.label }}
                      </h3>
                      <div class='{% if block.settings.display == 'swatches' %}grid grid-cols-4 gap-3{% else %}flex flex-wrap gap-2{% endif %}'>
                        {% assign has_set_default = false %}
                        {% for v in section.blocks %}
                          {% if v.type == "custom_option_value"
                            and v.settings.group_id == block.settings.group_id
                          %}
                            {% assign delta_str = v.settings.price_delta
                              | default: "0"
                            %}
                            {% assign delta_cents = delta_str
                              | replace: ",", "."
                              | times: 100
                              | round
                            %}
                            <label class='relative cursor-pointer'>
                              <input
                                type='radio'
                                name='properties[{{ block.settings.label }}]'
                                value='{{ v.settings.label }}'
                                class='sr-only custom-opt'
                                data-price-delta-cents='{{ delta_cents }}'
                                {% if has_set_default == false %}
                                  {%- assign has_set_default = true %}checked
                                {% endif %}
                              >
                              {% if block.settings.display == "swatches" %}
                                <div class='w-20 h-20 border-2 border-gray-300 hover:border-black rounded-lg p-2 bg-white hover:bg-gray-100 transition-colors'>
                                  {% if v.settings.image != blank %}
                                    <img
                                      src='{{ v.settings.image | image_url: width: 96 }}'
                                      alt='{{ v.settings.label }}'
                                      class='w-full h-full object-contain rounded-md'
                                    >
                                  {% else %}
                                    <div class='w-full h-full bg-white rounded-md flex items-center justify-center'>
                                      <span class='text-gray-600 text-xs text-center px-1'>
                                        {{- v.settings.label -}}
                                      </span>
                                    </div>
                                  {% endif %}
                                </div>
                                <span class='text-xs text-center block mt-1 font-medium'>
                                  {{- v.settings.label -}}
                                  {% if delta_cents > 0 -%}
                                    <span class='text-gray-500'>
                                      (+
                                      {{-
                                        delta_cents
                                        | divided_by: 100.0
                                        | money_without_trailing_zeros
                                      -}}
                                      )</span
                                    >
                                  {%- endif %}
                                </span>
                              {% else %}
                                <div class='px-3 h-10 inline-flex items-center justify-center rounded-md border text-sm font-medium transition-colors border-gray-300 hover:border-black bg-white text-gray-900'>
                                  {{ v.settings.label }}
                                  {% if delta_cents > 0 -%}
                                    <span class='ml-1 text-gray-500'
                                      >+
                                      {{-
                                        delta_cents
                                        | divided_by: 100.0
                                        | money_without_trailing_zeros
                                      -}}
                                    </span>
                                  {%- endif %}
                                </div>
                              {% endif %}
                            </label>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}

            <!-- Quantity Selector -->
            <div class='mb-6'>
              <label class='block text-sm font-medium text-gray-700 mb-2'>
                Quantity
              </label>
              <div class='flex items-center space-x-3'>
                <button
                  type='button'
                  @click='decreaseQuantity()'
                  class='w-10 h-10 rounded-md border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors'
                >
                  <svg
                    class='w-4 h-4'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                  </svg>
                </button>
                <input
                  type='number'
                  x-model='quantity'
                  min='1'
                  class='w-20 text-center border border-gray-300 rounded-md py-2 focus:ring-2 focus:ring-black focus:border-black'
                >
                <button
                  type='button'
                  @click='increaseQuantity()'
                  class='w-10 h-10 rounded-md border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors'
                >
                  <svg
                    class='w-4 h-4'
                    fill='none'
                    stroke='currentColor'
                    viewBox='0 0 24 24'
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Add to Cart Button -->
            <button
              id='addToCartBtn'
              type='submit'
              class='w-full bg-black hover:bg-gray-800 text-white font-semibold py-4 px-8 cursor-pointer transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] mb-6'
              {% if selected_variant.available == false %}
                disabled
              {% endif %}
            >
              {% if selected_variant.available == false -%}
                SOLD OUT
              {%- else -%}
                ADD TO CART
              {%- endif %}
            </button>
          {% endform %}
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const useCustom = {{ section.settings.use_custom_variants | json }};
    if (!useCustom) return;

    const priceEl = document.getElementById('price');
    const stickyPriceEl = document.getElementById('stickyPrice');
    const baseCents = 0;
    const locale = {{ shop.locale | json }};
    const currency = {{ shop.currency | json }};

    function formatCents(c) {
      try { return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(c / 100); } catch(e) { return (c/100).toFixed(2); }
    }

    function computeAdjustment() {
      const inputs = document.querySelectorAll('#custom-options .custom-opt:checked');
      let sum = 0;
      inputs.forEach(i => { const d = parseInt(i.getAttribute('data-price-delta-cents')||'0', 10); if (!isNaN(d)) sum += d; });
      return sum;
    }

    function updateDisplayedPrice() {
      const total = baseCents + computeAdjustment();
      if (priceEl) priceEl.textContent = formatCents(total);
      if (stickyPriceEl) stickyPriceEl.textContent = formatCents(total);
    }

    document.querySelectorAll('#custom-options .custom-opt').forEach(inp => {
      inp.addEventListener('change', updateDisplayedPrice);
    });

    updateDisplayedPrice();
  });
</script>

{% schema %}
{
  "name": "Product (Custom)",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Customer Reviews",
      "default": true
    },
    {
      "type": "text",
      "id": "reviews_heading",
      "label": "Reviews Section Heading",
      "default": "What our customers say"
    },
    {
      "type": "range",
      "id": "star_size_desktop",
      "label": "Star Size (Desktop)",
      "min": 12,
      "max": 32,
      "step": 2,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "star_size_mobile",
      "label": "Star Size (Mobile)",
      "min": 12,
      "max": 28,
      "step": 2,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "use_custom_variants",
      "label": "Use Custom Variants (override default variant UI)",
      "default": true
    }
  ],
  "blocks": [
    { "type": "vendor", "name": "Vendor", "limit": 1 },
    { "type": "title", "name": "Title", "limit": 1 },
    { "type": "price", "name": "Price", "limit": 1 },
    { "type": "description", "name": "Description", "limit": 1 },
    { "type": "variant_selector", "name": "Variant Selector", "limit": 1 },
    { "type": "checkout_buttons", "name": "Checkout Buttons", "limit": 1 },

    {
      "type": "custom_option_group",
      "name": "Custom Option Group",
      "settings": [
        {
          "type": "text",
          "id": "group_id",
          "label": "Group ID (unique, no spaces)",
          "default": "group_1"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Group Label",
          "default": "OPTION"
        },
        {
          "type": "select",
          "id": "display",
          "label": "Display Style",
          "options": [
            { "value": "buttons", "label": "Buttons" },
            { "value": "swatches", "label": "Image Swatches" }
          ],
          "default": "buttons"
        }
      ]
    },

    {
      "type": "custom_option_value",
      "name": "Custom Option Value",
      "settings": [
        {
          "type": "text",
          "id": "group_id",
          "label": "Group ID (match the group you want this value to belong to)",
          "default": "group_1"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Value Label",
          "default": "Value"
        },
        {
          "type": "text",
          "id": "price_delta",
          "label": "Price Delta (e.g. 10 or 10.50)",
          "default": "0"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Optional Image (for swatches)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product (Custom)",
      "blocks": [
        { "type": "vendor" },
        { "type": "title" },
        { "type": "price" },
        { "type": "description" },
        { "type": "variant_selector" },
        { "type": "checkout_buttons" },
        {
          "type": "custom_option_group",
          "settings": {
            "group_id": "blades",
            "label": "Blades",
            "display": "swatches"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "blades",
            "label": "Tumbled/Raw",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "blades",
            "label": "Black",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "blades",
            "label": "Tan",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "blades",
            "label": "Orange",
            "price_delta": "0"
          }
        },

        {
          "type": "custom_option_group",
          "settings": {
            "group_id": "handles",
            "label": "Handles",
            "display": "swatches"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "handles",
            "label": "Orange",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "handles",
            "label": "Black",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "handles",
            "label": "Earth Camo",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "handles",
            "label": "Tan",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "handles",
            "label": "Blue",
            "price_delta": "0"
          }
        },

        {
          "type": "custom_option_group",
          "settings": {
            "group_id": "sheath",
            "label": "Sheath",
            "display": "buttons"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "sheath",
            "label": "Black",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "sheath",
            "label": "Orange",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "sheath",
            "label": "Green",
            "price_delta": "0"
          }
        },

        {
          "type": "custom_option_group",
          "settings": {
            "group_id": "screws",
            "label": "Screws",
            "display": "buttons"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "screws",
            "label": "Silver",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "screws",
            "label": "Black",
            "price_delta": "0"
          }
        },
        {
          "type": "custom_option_value",
          "settings": {
            "group_id": "screws",
            "label": "Orange",
            "price_delta": "0"
          }
        }
      ]
    }
  ]
}
{% endschema %}
