{% if section.settings.show_timer %}
  <!-- Big Timer Section -->
  <div class='bg-gray-800 py-16 px-4'>
    <div class='max-w-4xl mx-auto text-center'>
      <!-- Main Title -->
      <h2 class='text-4xl md:text-5xl font-bold text-white mb-8  tracking-wide'>
        {{ section.settings.main_title | default: "Ovis Hunter Drop:" }}
      </h2>

      <!-- Countdown Timer -->
      <div
        class='flex justify-center items-center gap-2 sm:gap-4 my-8'
        x-data='countdownTimer()'
      >
        <!-- Days -->
        <div class='bg-gray-700 rounded-lg p-2 sm:p-4 min-w-[60px] sm:min-w-[80px]'>
          <div
            class='text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-1'
            x-text='days'
          ></div>
          <div class='text-xs text-white uppercase tracking-wide'>days</div>
        </div>

        <!-- Hours -->
        <div class='bg-gray-700 rounded-lg p-2 sm:p-4 min-w-[60px] sm:min-w-[80px]'>
          <div
            class='text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-1'
            x-text='hours'
          ></div>
          <div class='text-xs text-white uppercase tracking-wide'>hours</div>
        </div>

        <!-- Minutes -->
        <div class='bg-gray-700 rounded-lg p-2 sm:p-4 min-w-[60px] sm:min-w-[80px]'>
          <div
            class='text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-1'
            x-text='minutes'
          ></div>
          <div class='text-xs text-white uppercase tracking-wide'>minutes</div>
        </div>

        <!-- Seconds -->
        <div class='bg-gray-700 rounded-lg p-2 sm:p-4 min-w-[60px] sm:min-w-[80px]'>
          <div
            class='text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-1'
            x-text='seconds'
          ></div>
          <div class='text-xs text-white uppercase tracking-wide'>seconds</div>
        </div>
      </div>

      <!-- Slogan -->
      <p class='text-lg text-white mb-8'>
        {{
          section.settings.slogan
          | default: ""
        }}
      </p>

      <!-- Notify Me Button -->
      <div
        x-data='bladeDropForm()'
        class='relative'
      >
        {% if section.settings.button_action == 'link' and section.settings.button_url != blank %}
          <a
            href='{{ section.settings.button_url }}'
            class='inline-block font-semibold py-3 px-8 rounded-lg transition-colors duration-300'
            style='background-color: {{ section.settings.button_color | default: "#2563eb" }}; color: {{ section.settings.button_text_color | default: "#ffffff" }};'
          >
            {{ section.settings.button_text }}
          </a>
        {% else %}
          <button
            class='inline-block font-semibold py-3 px-8 rounded-lg transition-colors duration-300 klaviyo_form_trigger'
            style='background-color: {{ section.settings.button_color | default: "#2563eb" }}; color: {{ section.settings.button_text_color | default: "#ffffff" }};'
          >
            {{ section.settings.button_text | default: "NOTIFY ME" }}
          </button>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

<script type="text/javascript">
  const klaviyoTrigger = document.querySelector('.klaviyo_form_trigger')
  if (klaviyoTrigger) {
    klaviyoTrigger.addEventListener('click', function () {
      window._klOnsite = window._klOnsite || [];
      window._klOnsite.push(['openForm', 'TRArE7']);
    })
  }
</script>

<!-- Countdown Timer Script -->
<script>
  function countdownTimer() {
    return {
      days: '00',
      hours: '00',
      minutes: '00',
      seconds: '00',
      timerInterval: null,

      init() {
        this.updateCountdown()
        // Only start interval if we have a valid target date
        if (this.isValidTargetDate()) {
          this.timerInterval = setInterval(() => this.updateCountdown(), 1000)
        }
      },

      isValidTargetDate() {
        var targetDateString =
          '{{ section.settings.target_date | default: "2024-12-31T23:59:59" }}'
        var cleanDateString = targetDateString.trim()

        if (!cleanDateString.includes('T')) {
          cleanDateString += 'T23:59:59'
        }

        if (
          !cleanDateString.includes('Z') &&
          !cleanDateString.includes('+') &&
          !cleanDateString.includes('-', 10)
        ) {
          cleanDateString += 'Z'
        }

        var targetDate = new Date(cleanDateString).getTime()
        return !isNaN(targetDate) && targetDate > 0
      },

      updateCountdown() {
        var targetDateString =
          '{{ section.settings.target_date | default: "2024-12-31T23:59:59" }}'
        console.log('Target date string:', targetDateString)

        // Clean and validate the date string
        var cleanDateString = targetDateString.trim()

        // Ensure proper ISO format
        if (!cleanDateString.includes('T')) {
          cleanDateString += 'T23:59:59'
        }

        // Add timezone if not present
        if (
          !cleanDateString.includes('Z') &&
          !cleanDateString.includes('+') &&
          !cleanDateString.includes('-', 10)
        ) {
          cleanDateString += 'Z'
        }

        var targetDate = new Date(cleanDateString).getTime()

        // If date is invalid, use a fallback date
        if (isNaN(targetDate) || targetDate <= 0) {
          console.warn('Invalid target date, using fallback')
          targetDate = new Date('2025-12-31T23:59:59Z').getTime()
        }

        var now = new Date().getTime()
        var distance = targetDate - now

        if (distance < 0) {
          this.days = '00'
          this.hours = '00'
          this.minutes = '00'
          this.seconds = '00'
          console.log('Countdown reached zero - timer stopped')
          // Clear the interval to stop the infinite loop
          if (this.timerInterval) {
            clearInterval(this.timerInterval)
            this.timerInterval = null
          }
          return
        }

        this.days = Math.floor(distance / (1000 * 60 * 60 * 24))
          .toString()
          .padStart(2, '0')
        this.hours = Math.floor(
          (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        )
          .toString()
          .padStart(2, '0')
        this.minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
          .toString()
          .padStart(2, '0')
        this.seconds = Math.floor((distance % (1000 * 60)) / 1000)
          .toString()
          .padStart(2, '0')
      },
    }
  }

  function bladeDropForm() {
    return {
      showForm: false,
      showSuccess: false,
      name: '',
      email: '',
      submitting: false,
      errorMessage: '',

      openForm() {
        this.showForm = true
        this.errorMessage = ''
        this.name = ''
        this.email = ''
      },

      closeForm() {
        this.showForm = false
      },

      closeSuccess() {
        this.showSuccess = false
      },

      async submit(event) {
        this.errorMessage = ''
        this.submitting = true

        var form = event.target

        // Validate name field
        if (!this.name || !this.name.trim()) {
          this.errorMessage = 'Please enter your full name.'
          this.submitting = false
          return
        }

        // Validate email field
        if (!this.email || !this.email.trim()) {
          this.errorMessage = 'Please enter your email address.'
          this.submitting = false
          return
        }

        // Additional email format validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        if (!emailRegex.test(this.email)) {
          this.errorMessage = 'Please enter a valid email address.'
          this.submitting = false
          return
        }

        var formData = new FormData(form)

        try {
          var response = await fetch('/contact', {
            method: 'POST',
            body: formData,
            headers: {
              Accept: 'text/html,application/xhtml+xml',
            },
            credentials: 'same-origin',
          })

          if (response.ok) {
            // Optionally inspect response.text() or response.url for query params
            this.showForm = false
            this.showSuccess = true
            this.name = ''
            this.email = ''
          } else {
            // For error statuses, attempt to parse the response to get message
            var text = await response.text()
            this.errorMessage = 'Submission failed. Please try again.'
            console.warn('Form submission response text:', text)
          }
        } catch (err) {
          console.error('Error submitting form:', err)
          this.errorMessage = 'An error occurred. Please try again later.'
        } finally {
          this.submitting = false
        }
      },
    }
  }
</script>

{% schema %}
{
  "name": "Big Timer",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_timer",
      "label": "Show Timer Section",
      "default": true
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "main_title",
      "label": "Main Title",
      "default": "Ovis Hunter Drop:"
    },
    {
      "type": "text",
      "id": "slogan",
      "label": "Slogan",
      "default": "Working Knives For Working People."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "NOTIFY ME"
    },
    {
      "type": "select",
      "id": "button_action",
      "label": "Button action",
      "default": "klaviyo",
      "options": [
        { "value": "klaviyo", "label": "Open Klaviyo form" },
        { "value": "link", "label": "Go to link" }
      ]
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button link",
      "info": "Used when Button action is set to Go to link"
    },
    {
      "type": "header",
      "content": "Timer Settings"
    },
    {
      "type": "text",
      "id": "target_date",
      "label": "Target Date & Time",
      "default": "2026-01-30T19:00:00-05:00",
      "info": "Format: YYYY-MM-DDTHH:MM:SSÂ±HH:MM (e.g., 2026-01-30T19:00:00-05:00)"
    },
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "form_title",
      "label": "Form Title",
      "default": "Get Notified"
    },
    {
      "type": "text",
      "id": "form_subtitle",
      "label": "Form Subtitle",
      "default": "Enter your email to be notified when we launch"
    },
    {
      "type": "header",
      "content": "Success Notification"
    },
    {
      "type": "text",
      "id": "success_title",
      "label": "Success Title",
      "default": "You're on the list!"
    },
    {
      "type": "text",
      "id": "success_subtitle",
      "label": "Success Subtitle",
      "default": "We'll notify you when we launch"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Thanks for signing up!"
    },
    {
      "type": "select",
      "id": "success_button_color",
      "label": "Success Button Color",
      "options": [
        {
          "value": "bg-orange-500",
          "label": "Orange"
        },
        {
          "value": "bg-blue-500",
          "label": "Blue"
        },
        {
          "value": "bg-green-500",
          "label": "Green"
        },
        {
          "value": "bg-red-500",
          "label": "Red"
        },
        {
          "value": "bg-purple-500",
          "label": "Purple"
        },
        {
          "value": "bg-gray-800",
          "label": "Dark Gray"
        },
        {
          "value": "bg-black",
          "label": "Black"
        }
      ],
      "default": "bg-black"
    }
  ],
  "presets": [
    {
      "name": "Big Timer"
    }
  ]
}
{% endschema %}
